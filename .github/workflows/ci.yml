name: CI Pipeline

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [master]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [master]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: read

jobs:
  ci:
    name: CI Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter and Build Tools
        uses: ./.github/actions/setup-flutter

      - name: Verify dependencies
        run: |
          flutter doctor -v
          flutter pub get
          flutter pub outdated

      - name: Check code formatting
        run: dart format --output=none .

      - name: Run static analysis
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Run unit and widget tests
        run: |
          flutter test \
            --concurrency=8 \
            --test-randomize-ordering-seed=random \
            --coverage \
            --reporter=expanded

      - name: Build verification (debug APK)
        run: |
          flutter build apk --debug --target-platform android-arm64
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "Debug APK size: $APK_SIZE"

      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov.info
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test/
          retention-days: 7
          if-no-files-found: ignore
